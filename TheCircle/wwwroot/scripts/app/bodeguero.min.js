/*
    bodeguero v1.0 
    Edgar Fernando Carvajal Ulloa efcarvaj@espol.edu.ec
    Children International
*/
angular.module("bodeguero",["ui.router"]).config(["$stateProvider","$compileProvider",function(e,a){e.state("despachar",{templateUrl:"views/bodeguero/despachar.html",controller:"despachar"}).state("historial",{templateUrl:"views/bodeguero/historial.html",controller:"historial"}).state("historial.transferencias",{templateUrl:"views/bodeguero/historial.transferencias.html",controller:"historial.transferencias"}).state("historial.ingresoItems",{templateUrl:"views/bodeguero/historial.ingresoItems.html",controller:"historial.ingresoItems"}).state("stock",{templateUrl:"views/bodeguero/stock.html",controller:"stock"}).state("ingresar",{templateUrl:"views/bodeguero/ingresar.html",controller:"ingresar"}).state("compuesto",{templateUrl:"views/bodeguero/compuesto.html",controller:"compuesto"}),a.debugInfoEnabled(!1),a.commentDirectivesEnabled(!1),a.cssClassDirectivesEnabled(!1)}]).run(["$state","$http","$templateCache",function(e,a,o){checkSession(a),loadTemplates(e,"despachar",a,o)}]).factory("dataFac",["$http","$rootScope",function(e,a){function o(a,o){NProgress.start(),e({method:"GET",url:"/api/itemfarmacia/registro",params:o}).then(function(e){console.log("Items registrados",e.data),NProgress.done(),a.items.data=e.data},function(e){console.log("error getItemsRegistrados",e),notify("No se pudo cargar los items","danger"),NProgress.done()})}function t(a,o){NProgress.start(),e({method:"GET",url:"/api/transferencia/despachada/personal",params:o}).then(function(e){NProgress.done(),a.transferencias.data=e.data},function(e){console.log("error getTransferenciasDespachadas",e),notify("No se pudo cargar las trasnferencias despachadas","danger"),NProgress.done()})}function s(){e.get("/api/transferencia").then(function(e){console.log("Transferencias a despachar",e.data),i.transferencias=e.data,a.$broadcast("dataFac.transferencias")},function(e){console.log("error cargar stock",e)})}function n(a){e.get("/api/itemfarmacia/").then(function(e){console.log("Stock de bodega",e.data),i.stock=e.data,a.stock=i.stock},function(e){console.log("error getStock",e)})}function r(){e.get("/api/compuesto-categoria-unidades").then(function(e){i.compuestos=e.data.compuestos,i.categorias=e.data.categorias,i.unidades=e.data.unidades,a.$broadcast("compuesto-categoria-unidades")},function(e){console.log("Error cargar data",e)})}function c(){e.get("/api/compuesto").then(function(e){i.compuestos=e.data,a.$broadcast("dataFac.compuestos")},function(e){console.log("Error cargar compuestos",e)})}var i={stock:null,compuestos:null,categorias:null,transferencias:null,unidades:null,nombres:null,transferenciasDespachadas:{desde:null,hasta:null,data:null},itemsRegistrados:{desde:null,hasta:null,data:null},getItemsRegistrados:o,getTransferenciasDespachadas:t,getData:r,getStock:n,getCompuestos:c,getTransferencias:s};return i}]).controller("despachar",["$scope","$state","$http","dataFac",function(e,a,o,t){function s(){a.includes("despachar")?t.getTransferencias():refresh.stop(n)}e.transferencias=t.transferencias,e.transferencia=null;var n=refresh.go(s,1);e.$on("dataFac.transferencias",function(){e.transferencias=t.transferencias}),e.ver=function(a){e.transferencia=a,e.comentario=null},e.guardarEgreso=function(e,a,t){var r={idTransferencia:e,cantidad:a,comentario:function(){return t?t:""}()};refresh.stop(n),NProgress.start(),o.put("/api/transferencia/"+e+"/despachar",r).then(function(e){console.log("Se despacho la transferencia",e.data),notify("Transferencia ingresada exitosamente","success")},function(e){console.log("Error ingresar transferencia",e),notify("No se pudo ingresar la transferencia","danger")})["finally"](function(){NProgress.done(),$("#ver_transferencia").modal("hide"),n=refresh.go(s,1)})}}]).controller("historial",["$state",function(e){e.go("historial.transferencias")}]).controller("historial.transferencias",["$scope","$state","dataFac",function(e,a,o){e.transferencias=o.transferenciasDespachadas,e.transferencia=null,e.$watch("transferencias",function(){o.transferenciasDespachadas=e.transferencias}),e.generar=function(a,t){var s={desde:a,hasta:t};o.getTransferenciasDespachadas(e,s)},e.ver=function(a){e.transferencia=a}}]).controller("historial.ingresoItems",["$scope","$state","dataFac",function(e,a,o){e.items=o.itemsRegistrados,e.item=null,e.$watch("items",function(){o.itemsRegistrados=e.items}),e.generar=function(a,t){var s={desde:a,hasta:t};o.getItemsRegistrados(e,s)},e.ver=function(a){e.item=a}}]).controller("stock",["$scope","$state","dataFac",function(e,a,o){function t(){o.getStock(e)}e.stock=o.stock;var s=refresh.go(t,1);e.$on("$destroy",function(){refresh.stop(s)})}]).controller("ingresar",["$state","$scope","$http","dataFac",function(e,a,o,t){t.getData(),a.compuestos=t.compuestos,a.nombres=t.nombres,null===a.compuestos&&t.getCompuestos(),a.$on("compuesto-categoria-unidades",function(){a.compuestos=t.compuestos}),a.seleccionar=function(e){a.form.nombre=e},o.get("/api/itemfarmacia/nombre").then(function(e){t.nombres=e.data,a.nombres=t.nombres},function(){}),a.crear=function(a){var t={nombre:a.nombre,compuesto:a.compuesto,fcaducidad:date(a.fecha),cantidad:a.cantidad};console.log("data a enviar",t),o.post("api/itemfarmacia",t).then(function(a){console.log("Ingreso exitoso",a.data),notify("Ingreso exitoso","success"),e.reload()},function s(s){console.log("No se pudo guardar",s),notify("No se ha podido guardar el ingreso","danger")})}}]).controller("compuesto",["$state","$scope","$http","dataFac",function(e,a,o,t){a.categorias=t.categorias,a.unidades=t.unidades,a.compuestos=t.compuestos,t.getData(),a.$on("compuesto-categoria-unidades",function(){a.categorias=t.categorias,a.unidades=t.unidades,a.compuestos=t.compuestos}),a.crear=function(a){var t={nombre:a.nombre,categoria:a.categoria,unidad:a.unidad};console.log(a,t),o.post("/api/compuesto",t).then(function(a){console.log("Ingreso exitoso",a),notify("Ingreso exitoso de compuesto","success"),e.reload()},function(e){console.log("No se pudo guardar el compuesto",e),notify("No se ha podido guardar el compuesto","danger")})},a.reset=function(){e.reload()}}]);