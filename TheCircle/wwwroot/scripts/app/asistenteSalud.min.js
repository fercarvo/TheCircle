/*
    asistenteSalud v1.0 
    Edgar Fernando Carvajal Ulloa efcarvaj@espol.edu.ec
    Children International
*/
angular.module("asistenteSalud",["ui.router"]).config(["$stateProvider","$compileProvider",function(e,a){e.state("despachar",{templateUrl:"views/asistente/despachar.html",controller:"despachar"}).state("despachar.receta",{templateUrl:"views/asistente/despachar.receta.html",controller:"despachar.receta"}).state("despachar.transferencias",{templateUrl:"views/asistente/despachar.transferencias.html",controller:"despachar.transferencias"}).state("despachar.pedidointerno",{templateUrl:"views/asistente/despachar.pedidointerno.html",controller:"despachar.pedidointerno"}).state("historial",{templateUrl:"views/asistente/historial.html",controller:"historial"}).state("historial.recetas",{templateUrl:"views/asistente/historial.recetas.html",controller:"historial.recetas"}).state("historial.transferencias",{templateUrl:"views/asistente/historial.transferencias.html",controller:"historial.transferencias"}).state("historial.ingresoItems",{templateUrl:"views/asistente/historial.ingresoItems.html",controller:"historial.ingresoItems"}).state("stock",{templateUrl:"views/asistente/stock.html",controller:"stock"}).state("ingresar",{templateUrl:"views/asistente/ingresar.html",controller:"ingresar"}).state("ingresar.items",{templateUrl:"views/asistente/ingresar.items.html",controller:"ingresar.items"}).state("ingresar.transferencias",{templateUrl:"views/asistente/ingresar.transferencias.html",controller:"ingresar.transferencias"}),a.debugInfoEnabled(!1),a.commentDirectivesEnabled(!1),a.cssClassDirectivesEnabled(!1)}]).run(["$state","$http","$templateCache",function(e,a,t){checkSession(a),loadTemplates(e,"despachar",a,t)}]).factory("dataFac",["$http","$rootScope",function(e,a){function t(a,t){NProgress.start(),e({method:"GET",url:"/api/itemfarmacia/registro",params:t}).then(function(e){console.log("Items registrados",e.data),NProgress.done(),a.items.data=e.data},function(e){console.log("error getItemsRegistrados",e),notify("No se pudo cargar los items","danger"),NProgress.done()})}function r(a,t){NProgress.start(),e({method:"GET",url:"/api/transferencia/despachada/personal",params:t}).then(function(e){console.log("Transferencias despachadas",e.data),NProgress.done(),a.transferencias.data=e.data},function(e){console.log("error getTransferenciasDespachadas",e),notify("No se pudo cargar las trasnferencias despachadas","danger"),NProgress.done()})}function n(a,t){NProgress.start(),e.put("/api/transferencia/"+a.idTransferencia+"/despachar",a).then(function(e){$("#ver_transferencia").modal("hide"),console.log("Transferencia despachada",e.data),c(t),notify("Transferencia despachada exitosamente","success"),NProgress.done()},function(e){$("#ver_transferencia").modal("hide"),console.log("No se despacho la transferencia",e),notify("No se pudo despachar la transferencia","danger"),NProgress.done()})}function s(){e.get("/api/pedidointerno/pendientes").then(function(e){u.pedidoInterno=e.data,a.$broadcast("dataFac.pedidoInterno")},function(e){console.log("Error: ",e)})}function o(a){e.get("/api/transferencia/despachada").then(function(e){console.log("getTransferenciasPorIngresar",e.data),u.transferenciasPorIngresar=e.data,a.transferencias=u.transferenciasPorIngresar},function(e){console.log("Error getTransferenciasPorIngresar",e)})}function c(a){e.get("/api/transferencia").then(function(e){console.log("Transferencias pendientes",e.data),u.transferencias=e.data,a.transferencias=u.transferencias},function(e){console.log("Error cargar transferencias",e),notify("No se pudieron cargar las transferencias","danger")})}function i(a){e.get("/api/compuesto").then(function(e){u.compuestos=e.data,a.compuestos=u.compuestos},function(e){console.log("Error cargar nombre items farmacia",e)})}function d(a){e.get("/api/itemfarmacia/").then(function(e){console.log("Stock de farmacia",e.data),u.stock=e.data,a.stock=u.stock},function(e){console.log("error getStock",e)})}function l(){e.get("/api/receta/localidad/pordespachar").then(function(e){console.log("Recetas a despachar",e.data),u.recetas=e.data,a.$broadcast("dataFac.recetas")},function(e){console.log("error cargar recetas",e)})}function f(a,t){NProgress.start(),e({method:"GET",url:"/api/receta/asistente",params:t}).then(function(e){console.log("getDespachos",e.data),a.despachos.data=e.data,NProgress.done()},function(e){console.log("error getDespachos",e),notify("Error al cargar la informacion","danger"),NProgress.done()})}var u={stock:null,compuestos:null,recetas:null,recetasDespachadas:{desde:null,hasta:null,data:null},transferencias:null,transferenciasPorIngresar:null,pedidoInterno:null,transferenciasDespachadas:{desde:null,hasta:null,data:null},itemsRegistrados:{desde:null,hasta:null,data:null},getItemsRegistrados:t,getTransferenciasDespachadas:r,getTransferenciasPorIngresar:o,getTransferenciasPendientes:c,getStock:d,getRecetas:l,getDespachos:f,getCompuestos:i,getPedidoInterno:s,despacharTransferencia:n};return u}]).factory("crearDespacho",["$http",function(e){return function(a){var t=a.receta.id;return items=[],a.items.forEach(function(e){var a={itemReceta:e.id,cantidad:null,comentario:e.comentario};e.nuevaCantidad?(a.cantidad=e.nuevaCantidad,items.push(a)):(a.cantidad=e.cantidad,items.push(a))}),console.log("Items",items),e.put("api/receta/"+t,items)}}]).controller("despachar",["$state",function(e){e.go("despachar.receta")}]).controller("despachar.receta",["$scope","$state","$http","dataFac","crearDespacho",function(e,a,t,r,n){function s(){a.includes("despachar.receta")?r.getRecetas():refresh.stop(o)}e.recetas=r.recetas,e.receta=null,e.index=null;var o=refresh.go(s,1);e.$on("dataFac.recetas",function(){e.recetas=r.recetas}),e.select=function(a,t){refresh.stop(o),e.receta=angular.copy(a),e.receta.items.forEach(function(e){e.cambio=!0}),e.index=t},e.cambiar=function(e){e.cambio=!1},e.despachar=function(e){e.disable=!0,e["class"]="glyphicon glyphicon-ok",e.count=1,console.log("despachar",e)},e.guardarEgreso=function(e,a,t){var r=e.items.reduce(function(e,a){return e+a.count},0);r===e.items.length?n(e).then(function(e){console.log("Despacho exitoso"),notify("Receta despachada exitosamente","success"),$("#myModal").modal("hide"),o=refresh.go(s,1)},function(e){console.log("Error despacho",e),$("#myModal").modal("hide"),notify("No se ha podido despachar","danger"),o=refresh.go(s,1)}):(o=refresh.go(s,1),console.log("No se han despachado todos los items",r),notify("No se han despachado todos los items","danger"))}}]).controller("despachar.pedidointerno",["$scope","$state","$http","dataFac",function(e,a,t,r){function n(){a.includes("despachar.pedidointerno")?r.getPedidoInterno():refresh.stop(s)}e.pedidoInterno=r.pedidoInterno,e.pedido=null;var s=refresh.go(n,30);e.$on("dataFac.pedidoInterno",function(){e.pedidoInterno=r.pedidoInterno}),e.ver=function(a){e.pedido=a,e.comentario=null,e.cantidad=null},e.guardarEgreso=function(a,r){var o={cantidad:a,comentario:r};NProgress.start(),t.put("api/pedidointerno/"+e.pedido.id+"/despachar",o).then(function(){$("#ver_pedido").modal("hide"),s=refresh.go(n,30),notify("Pedido despachado exitosamente","success"),NProgress.done()},function(e){$("#ver_pedido").modal("hide"),console.log("No se despacho",e),notify("No se pudo despachar","danger"),NProgress.done()})}}]).controller("despachar.transferencias",["$scope","dataFac",function(e,a){function t(){a.getTransferenciasPendientes(e)}e.transferencias=a.transferencias,e.transferencia=null;var r=refresh.go(t,1);e.$on("$destroy",function(){refresh.stop(r)}),e.ver=function(a){e.transferencia=a,e.comentario=null,e.nuevaCantidad=null},e.guardarEgreso=function(t,r,n){var s={idTransferencia:t,cantidad:function(){return r?r:e.transferencia.cantidad}(),comentario:function(){return n?n:""}()};a.despacharTransferencia(s,e)}}]).controller("historial",["$state",function(e){e.go("historial.recetas")}]).controller("historial.recetas",["$scope","$state","$http","dataFac",function(e,a,t,r){e.despachos=r.recetasDespachadas,e.receta=null,e.$watch("despachos",function(){r.recetasDespachadas=e.despachos}),e.generar=function(a,t){var n={desde:a,hasta:t};r.getDespachos(e,n)},e.select=function(a){e.receta=a}}]).controller("historial.transferencias",["$scope","$state","dataFac",function(e,a,t){e.transferencias=t.transferenciasDespachadas,e.transferencia=null,e.$watch("transferencias",function(){t.transferenciasDespachadas=e.transferencias}),e.generar=function(a,r){var n={desde:a,hasta:r};t.getTransferenciasDespachadas(e,n)},e.ver=function(a){e.transferencia=a}}]).controller("historial.ingresoItems",["$scope","$state","dataFac",function(e,a,t){e.items=t.itemsRegistrados,e.item=null,e.$watch("items",function(){t.itemsRegistrados=e.items}),e.generar=function(a,r){var n={desde:a,hasta:r};t.getItemsRegistrados(e,n)},e.ver=function(a){e.item=a}}]).controller("stock",["$scope","$state","dataFac",function(e,a,t){function r(){t.getStock(e)}e.stock=t.stock;var n=refresh.go(r,1);e.$on("$destroy",function(){refresh.stop(n)})}]).controller("ingresar",["$state",function(e){e.go("ingresar.items")}]).controller("ingresar.items",["$scope","$state","$http","dataFac",function(e,a,t,r){e.compuestos=r.compuestos,e.items=null,null===e.compuestos&&r.getCompuestos(e),e.crear=function(e,r,n,s){var o={compuesto:e,nombre:r,fcaducidad:date(n),cantidad:s};console.log("data a enviar",o),t.post("api/itemfarmacia",o).then(function(e){console.log("Ingreso exitoso",e.data),notify("Ingreso en farmacia exitoso","success"),a.reload()},function c(c){console.log("No se pudo guardar el ingreso",c),notify("No se ha podido guardar el ingreso en farmacia","danger")})}}]).controller("ingresar.transferencias",["$scope","$state","$http","dataFac",function(e,a,t,r){function n(){r.getTransferenciasPorIngresar(e)}e.transferencias=r.transferenciasPorIngresar,e.transferencia=null;var s=refresh.go(n,1);e.$on("$destroy",function(){refresh.stop(s)}),e.ver=function(a){e.transferencia=a},e.guardarIngreso=function(a){refresh.stop(s);var r={idTransferencia:e.transferencia.id,comentario:function(){return a?a:""}()};NProgress.start(),t.post("/api/itemfarmacia/transferencia",r).then(function(e){$("#ver_transferencia").modal("hide"),s=refresh.go(n,1),notify("Transferencia ingresada exitosamente","success"),NProgress.done()},function(e){refresh.go(n,1),console.log("Error ingresar transferencia",e),notify("No se pudo ingresar la transferencia","danger"),NProgress.done()})}}]);