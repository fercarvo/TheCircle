/*
 appMedico v1.0
 Edgar Fernando Carvajal Ulloa efcarvaj@espol.edu.ec
 Children International
*/

angular.module("appMedico",["ui.router","nvd3"]).config(["$stateProvider","$compileProvider",function(e,t){e.state("atencion",{templateUrl:"views/medico/atencion.html",controller:"atencion"}).state("atencion.registro",{templateUrl:"views/medico/atencion.registro.html",controller:"atencion.registro"}).state("atencion.receta",{templateUrl:"views/medico/atencion.receta.html",controller:"atencion.receta"}).state("atencion.remision",{templateUrl:"views/medico/atencion.remision.html",controller:"atencion.remision"}).state("anulaciones",{templateUrl:"views/medico/anulaciones.html",controller:"anulaciones"}).state("estadisticas",{templateUrl:"views/medico/estadistica.html",controller:"estadisticas"}).state("estadisticas.atenciones",{templateUrl:"views/medico/estadistica.atenciones.html",controller:"estadisticas.atenciones"}).state("estadisticas.remisiones",{templateUrl:"views/medico/estadistica.remisiones.html",controller:"estadisticas.remisiones"}).state("estadisticas.recetas",{templateUrl:"views/medico/estadistica.recetas.html",controller:"estadisticas.recetas"}).state("estadisticas.enfermedades",{templateUrl:"views/medico/estadistica.enfermedades.html",controller:"estadisticas.enfermedades"}).state("pedidos",{templateUrl:"views/medico/pedidos.html",controller:"pedidos"}).state("pedidos.generar",{templateUrl:"views/medico/pedidos.generar.html",controller:"pedidos.generar"}).state("pedidos.receptar",{templateUrl:"views/medico/pedidos.receptar.html",controller:"pedidos.receptar"}),t.debugInfoEnabled(!1),t.commentDirectivesEnabled(!1),t.cssClassDirectivesEnabled(!1)}]).run(["$state","$http","$templateCache",function(e,t,o){checkSession(t),loadTemplates(e,"atencion",t,o)}]).factory("dataFactory",["$http","$rootScope",function(e,t){function o(t){e.get("/api/pedidointerno/despachadas").then(function(e){console.log("Pedidos internos",e.data),u.pedidosInternos=e.data,t.pedidosInternos=u.pedidosInternos},function(e){console.log("Error pedidos: ",e),notify("No se pudo cargar pedidos internos","danger")})}function a(){e.get("/api/itemfarmacia/report").then(function(e){u.stockChildren=e.data,t.$broadcast("dataFactory.stockChildren")},function(e){console.log("Error cargar Stock",e)})}function n(){e.get("/api/itemfarmacia/insumos").then(function(e){u.stockInsumos=e.data,t.$broadcast("dataFactory.stockInsumos")},function(e){console.log("Error cargar Stock de farmacia",e)})}function i(){return e.get("/api/institucion",{cache:!0}).then(function(e){u.instituciones=e.data,t.$broadcast("dataFactory.instituciones")},function(e){console.log("Error cargar instituciones",e)})}function s(t){e.get("/api/enfermedad").then(function(e){t.enfermedades=e.data},function(e){console.log("Error cargar enfermedades",e)})}function r(){e.get("/api/itemfarmacia").then(function(e){console.log("Actualizando Stock by localidad",e.data);var o=[];e.data.forEach(function(e){"MED"===e.grupo&&o.push(e)}),u.stock=o,console.log(u.stock),t.$broadcast("dataFactory.stock")},function(e){console.log("Error cargar Stock de farmacia",e)})}function c(){e.get("api/receta/medico/activas").then(function(e){console.log("recetas by status",e.data),u.recetas=e.data,t.$broadcast("dataFactory.recetas")},function(e){console.log("error cargar recetas",e)})}function d(t){NProgress.start();var o=e.get("/api/apadrinado/"+t,{cache:!0});return o.then(function(){NProgress.done()},function(e){console.log("No existe apadrinado",e),NProgress.done()}),o}function l(t){NProgress.start();var o=e.post("/api/remision",t);return o.then(function(e){NProgress.done(),console.log("se creo remision",e.data),notify("Se creo la remision exitosamente","success")},function(e){NProgress.done(),console.log("error crear remision",e),notify("No se pudo generar la remision, por favor verifique los datos","danger")}),o}var u={enfermedades:null,instituciones:null,stockChildren:null,stock:null,stockInsumos:null,recetas:null,estadisticas:{},pedidosInternos:null,tipos:["curativo","seguimiento","control"],getStockChildren:a,getInstituciones:i,getEnfermedades:s,getStock:r,getStockInsumos:n,getRecetas:c,getApadrinado:d,postRemision:l,getPedidosAReceptar:o};return u}]).factory("disable",[function(){return{atencion:!1,remision:!1,receta:!1}}]).factory("atencionFactory",["$http",function(e){function t(t){e.get("/api/remision/gastado").then(function(e){console.log("Monto",e.data),o.monto=e.data,t.monto=o.monto},function(){})}var o={apadrinado:{},foto:"/images/foto.png",codigo:null,atencion:null,diagnosticos:null,remision:null,receta:{items:[],id:null},status:!0,monto:null,getMonto:t};return o}]).controller("atencion",["$scope","$state","atencionFactory","dataFactory","disable",function(e,t,o,a,n){function i(){var t=e.$on("guardar",function(){e.disable=n.atencion,t(),a()}),a=e.$watch("apadrinado",function(){o.apadrinado=e.apadrinado,o.status=e.status,o.codigo=e.codigo,o.foto=e.foto})}t.go("atencion.registro"),e.codigo=o.codigo,e.disable=n.atencion,e.apadrinado=o.apadrinado,e.foto=o.foto,e.status=o.status,n.atencion===!1&&i(),e.imc=function(e,t){if(!e||!t)return"";var o=10*e/(t/100*t/100)/10;return 18.5>o?"Bajo peso":25>o?"Normal":30>o?"Sobrepeso":35>o?"Obesidad I":40>o?"Obesidad II":50>o?"Obesidad III":o>=50?"Obesidad IV":""},e.buscarApadrinado=function(t){a.getApadrinado(t).then(function(o){switch(o.data.status){case"D":case"E":e.status=!1;break;default:e.status=!0}e.foto="/api/apadrinado/"+t+"/foto",e.apadrinado=o.data},function(){e.foto="/images/foto.png",e.status=!0,e.codigo=null,e.apadrinado={}})}}]).controller("atencion.registro",["$scope","$state","$http","dataFactory","atencionFactory","disable",function(e,t,o,a,n,i){e.disable=i.atencion,e.enfermedades=null,e.tipos=a.tipos,e.atencion=n.atencion,a.getEnfermedades(e),e.reset=function(){e.atencion={}},e.$watch("atencion",function(){n.atencion=e.atencion}),e.send=function(){var a={apadrinado:n.codigo,tipo:n.atencion.tipo,diagnosticos:[n.atencion.diagp,n.atencion.diag1,n.atencion.diag2],peso:n.atencion.peso,talla:n.atencion.talla};NProgress.start(),o.post("/api/atencion",a).then(function(o){NProgress.done(),console.log("Se creo atencion",o.data),i.atencion=!0,n.atencion=o.data.atencion,n.diagnosticos=o.data.diagnosticos,e.disable=i.atencion,e.$emit("guardar"),notify("Atención creada satisfactoriamente","success"),t.go("atencion.receta")},function(e){NProgress.done(),notify("Intento fallido de atencion medica","danger"),console.log("error atencion",e)})}}]).controller("atencion.remision",["$scope","$state","disable","dataFactory","atencionFactory",function(e,t,o,a,n){e.disable=o.remision,e.remision=n.remision,e.instituciones=a.instituciones,e.diagnosticos=n.diagnosticos,e.monto=n.monto,null===e.monto&&n.getMonto(e),null===a.instituciones&&a.getInstituciones(),e.$on("dataFactory.instituciones",function(){e.instituciones=a.instituciones}),e.send=function(t){var i={atencionM:n.atencion.id,institucion:t.institucion,monto:t.monto,sintomas:t.sintomas};a.postRemision(i).then(function(t){o.remision=!0,n.remision=e.remision,e.disable=o.remision,openURL("/api/remision/"+t.data.id+"/imprimir")},function(){})}}]).controller("atencion.receta",["$scope","$state","$http","disable","dataFactory","atencionFactory",function(e,t,o,a,n,i){function s(){t.includes("atencion.receta")&&null!==i.codigo?n.getStock():refresh.stop(r)}e.disable=a.receta,e.stock=n.stock,e.receta=i.receta,e.ItemRecetaNuevo={},e.editarItem=!0,e.diagnosticos=i.diagnosticos;var r=refresh.go(s);e.$on("dataFactory.stock",function(){e.stock=n.stock}),e.$watch("receta.items",function(){i.receta.items=e.receta.items,e.receta.items=i.receta.items}),e.addItenReceta=function(t){$("#modal_crearItem").modal("hide"),r=refresh.go(s),e.receta.items.push(angular.copy(t))},e.eliminarItem=function(e,t){console.log("Eliminando item"),e.splice(t,1)},e.select=function(t){refresh.stop(r),e.ItemRecetaNuevo.itemFarmacia=angular.copy(t),e.ItemRecetaNuevo.diagnostico=null,e.ItemRecetaNuevo.cantidad=1,e.ItemRecetaNuevo.posologia=null},e.guardarReceta=function(){var t=i.receta.items;NProgress.start(),o.post("/api/receta/apadrinado/"+i.codigo,JSON.parse(angular.toJson(t))).then(function(t){NProgress.done(),console.log("Creo la receta",t.data),notify("Se creo la receta exitosamente","success"),i.receta.id=t.data.id,e.receta.id=i.receta.id,a.receta=!0,e.disable=a.receta,refresh.stop(r),s(),openURL("/api/receta/"+t.data.id+"/imprimir")},function n(n){NProgress.done(),console.log("Error al crear receta",n),notify("No se ha podido crear la receta, por favor verifique los items","danger")})}}]).controller("anulaciones",["$scope","$state","$http","dataFactory",function(e,t,o,a){function n(){t.includes("anulaciones")?a.getRecetas():refresh.stop(i)}e.recetas=a.recetas,e.receta=null;var i=refresh.go(n);e.$on("dataFactory.recetas",function(){e.recetas=a.recetas}),e.select=function(t){refresh.stop(i),e.receta=t},e.cancelar=function(){i=refresh.go(n)},e.eliminarReceta=function(e){o["delete"]("/api/receta/"+e.receta.id).then(function(t){i=refresh.go(n),console.log("Receta eliminada con exito",e,t),notify("Receta eliminada con exito","success")},function(e){i=refresh.go(n),console.log("No se pudo eliminar receta",e),notify("Receta no se pudo eliminar","danger")})}}]).controller("estadisticas",["$state",function(e){e.go("estadisticas.enfermedades")}]).controller("estadisticas.atenciones",["$scope","$state","$http","dataFactory",function(e,t,o,a){e.atenciones=a.estadisticas.atenciones,e.$watch("atenciones",function(){a.estadisticas.atenciones=e.atenciones}),e.generar=function(t,a){var n={desde:date(t),hasta:date(a)};NProgress.start(),o({method:"GET",url:"/api/atencion/medico",params:n}).then(function(t){e.atenciones.all=t.data,console.log(e.atenciones.all),NProgress.done()},function(e){console.log("error cargar atenciones",e),notify("No se pudo cargar atenciones médicas","danger"),NProgress.done()})}}]).controller("estadisticas.remisiones",["$scope","$state","$http","dataFactory",function(e,t,o,a){e.remisiones=a.estadisticas.remisiones,e.$watch("remisiones",function(){a.estadisticas.remisiones=e.remisiones}),e.generar=function(t,a){var n={desde:date(t),hasta:date(a)};NProgress.start(),o({method:"GET",url:"/api/reporte/remision/date",params:n}).then(function(t){e.remisiones.all=t.data,NProgress.done()},function(e){console.log("error cargar remisiones",e),notify("No se pudo cargar remisiones","danger"),NProgress.done()})}}]).controller("estadisticas.recetas",["$scope","$state","$http","dataFactory",function(e,t,o,a){e.recetas=a.estadisticas.recetas,e.$watch("recetas",function(){a.estadisticas.recetas=e.recetas}),e.select=function(t){e.receta=t},e.generar=function(t,a){var n={desde:date(t),hasta:date(a)};NProgress.start(),o({method:"GET",url:"/api/receta/medico/fecha",params:n}).then(function(t){NProgress.done(),e.recetas.all=t.data},function(e){console.log("error cargar recetas"),notify("No se pudo cargar recetas","danger"),NProgress.done()})}}]).controller("estadisticas.enfermedades",["$scope","$state","$http","dataFactory",function(e,t,o,a){e.enfermedades=a.estadisticas.enfermedades,e.$watch("enfermedades",function(){a.estadisticas.enfermedades=e.enfermedades}),e.generar=function(t,a){var s={desde:date(t),hasta:date(a)};NProgress.start(),o({method:"GET",url:"/api/reporte/enfermedad/date",params:s}).then(function(t){for(e.data=[],i=0;i<t.data.length;i++)e.data.push({key:t.data[i].codigo+" "+t.data[i].nombre,y:t.data[i].veces,color:n[i]});NProgress.done()},function(e){console.log("Error cargar estadisticas",e),notify("No se pudo cargar las enfermedades","danger"),NProgress.done()})};var n=["#901F61","#009877","#D64227","#FED115","#ADBF2B"];e.options={chart:{type:"pieChart",height:340,x:function(e){return e.key},y:function(e){return e.y},showLabels:!1,duration:500,labelThreshold:0,labelSunbeamLayout:!0,legendPosition:"top",legend:{margin:{top:5,right:35,bottom:5,left:0}}}}}]).controller("pedidos",["$state",function(e){e.go("pedidos.generar")}]).controller("pedidos.generar",["$scope","$http","$state","dataFactory",function(e,t,o,a){function n(){o.includes("pedidos.generar")?a.getStockInsumos():refresh.stop(i)}console.log("En generar"),e.stock=a.stockInsumos,e.item=null;var i=refresh.go(n,1);e.$on("dataFactory.stockInsumos",function(){e.stock=a.stockInsumos}),e.seleccionar=function(t){e.item=t,$("#despachar").modal("show"),e.cantidad=null},e.solicitar=function(o){data={item:e.item.id,cantidad:o},refresh.stop(i),NProgress.start(),t.post("/api/pedidointerno",data).then(function(e){console.log("Se creo el pedido interno",e),notify("El pedido interno se creo exitosamente","success")},function(e){console.log("No se pudo crear el pedido interno",e),notify("No se pudo crear el pedido interno","danger")})["finally"](function(){NProgress.done(),$("#despachar").modal("hide"),o=1,i=refresh.go(n,30)})}}]).controller("pedidos.receptar",["$scope","$state","dataFactory","$http",function(e,t,o,a){function n(){t.includes("pedidos.receptar")?o.getPedidosAReceptar(e):refresh.stop(i)}e.pedidosInternos=o.pedidosInternos,e.pedido=null;var i=refresh.go(n,1);e.ver=function(t){e.pedido=t,e.comentario=null},e.guardarComentario=function(e,t){refresh.stop(i),NProgress.start(),a.put("/api/pedidointerno/"+e+"/receptar",{comentario:t}).then(function(){$("#ver_pedido").modal("hide"),i=refresh.go(n,1),notify("Pedido receptado exitosamente","success"),NProgress.done()},function(e){$("#ver_pedido").modal("hide"),i=refresh.go(n,1),console.log("No se recepto",e),notify("No se pudo receptar el pedido","danger"),NProgress.done()})}}]);